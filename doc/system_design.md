# OpenManus 系统设计文档

## 1. 项目概述

OpenManus是一个开源的通用AI代理框架，旨在提供类似于Manus的功能，但无需邀请码。该项目由MetaGPT社区的贡献者开发，提供了一个灵活的框架，使用户能够构建和部署具有多种工具和能力的AI代理。

项目目标：
- 创建一个易于使用的AI代理框架
- 提供丰富的工具集，使代理能够执行各种任务
- 支持多种大语言模型(LLM)
- 提供Web界面和API接口

## 2. 核心技术栈

1. **编程语言**: Python 3.12
2. **Web框架**: FastAPI
3. **大语言模型(LLM)集成**: 
   - 支持OpenAI API (GPT-4o等)
   - 支持Azure OpenAI
   - 支持Claude模型
4. **前端**: HTML/CSS/JavaScript，使用Jinja2模板
5. **异步处理**: 使用Python的asyncio库
6. **依赖管理**: 支持pip和uv包管理器

## 3. 系统架构

### 3.1 代理架构

OpenManus采用了分层的代理架构设计：

- **BaseAgent**: 基础代理类，提供状态管理、内存管理和执行循环的基础功能
- **ReActAgent**: 实现了ReAct（Reasoning and Acting）模式的代理，定义了思考(think)和行动(act)的抽象方法
- **ToolCallAgent**: 扩展了ReAct代理，专门处理工具/函数调用，能够解析LLM的工具调用并执行相应操作
- **Manus**: 最终的代理实现，集成了多种工具，包括Python执行、网页浏览、文件操作和信息检索等

### 3.2 工具系统

项目实现了一个灵活的工具系统，允许代理使用各种功能：

- **BaseTool**: 所有工具的基类，定义了工具的基本接口
- **ToolCollection**: 管理多个工具的集合，提供工具注册和执行的功能
- **具体工具实现**:
  - **BrowserUseTool**: 网页浏览工具，支持导航、点击、输入文本、截图等操作
  - **GoogleSearch**: 谷歌搜索工具，获取网络信息
  - **PythonExecute**: Python代码执行工具，可以运行用户提供的Python代码
  - **FileSaver**: 文件保存工具
  - **Terminate**: 终止代理执行的工具

### 3.3 LLM集成

项目提供了灵活的LLM集成机制：

- **LLM类**: 封装了与大语言模型的交互，支持OpenAI和Azure OpenAI API
- **配置系统**: 通过TOML配置文件管理LLM设置，支持多种模型配置
- **重试机制**: 使用tenacity库实现API调用的指数退避重试

### 3.4 Web应用

项目包含一个完整的Web应用程序：

- **FastAPI后端**: 提供RESTful API接口
- **服务器发送事件(SSE)**: 用于实时更新代理执行状态
- **任务管理**: 支持创建、监控和管理多个代理任务
- **静态文件服务**: 提供前端资源

### 3.5 内存和状态管理

- **Memory类**: 管理代理的对话历史
- **Message类**: 表示不同类型的消息（用户、系统、助手、工具）
- **AgentState**: 管理代理的状态（空闲、运行中、完成、错误）

## 4. 核心入口

OpenManus提供了多个入口点，适用于不同的使用场景：

### 4.1 命令行入口

**main.py**
- 项目的主要命令行入口
- 创建Manus代理实例并处理用户输入
- 提供简单的交互式界面
- 适合快速测试和简单使用场景

```python
# 主要执行流程：
# 1. 创建Manus代理实例
# 2. 循环接收用户输入
# 3. 调用代理的run方法处理请求
# 4. 输出结果
```

### 4.2 Web应用入口

**app.py**
- 基于FastAPI的Web应用入口
- 提供RESTful API和Web界面
- 支持任务创建、监控和管理
- 使用SSE实现实时更新
- 适合多用户和生产环境

```python
# 主要功能：
# 1. 定义API路由和处理函数
# 2. 管理任务队列和状态
# 3. 提供Web界面
# 4. 处理异步事件流
```

### 4.3 开发版入口

**run_flow.py**
- 用于开发和测试的入口
- 提供更多调试信息
- 支持实验性功能
- 适合开发者使用

## 5. 核心包的作用

### 5.1 app包

app包是项目的核心，包含了代理、工具、LLM集成等主要功能：

#### 5.1.1 app/agent

- **base.py**: 定义BaseAgent抽象类，提供代理的基础功能
- **react.py**: 实现ReActAgent，提供思考和行动的框架
- **toolcall.py**: 实现ToolCallAgent，处理工具调用
- **manus.py**: 实现Manus代理，集成各种工具

#### 5.1.2 app/tool

- **base.py**: 定义BaseTool抽象类和ToolResult类
- **tool_collection.py**: 实现ToolCollection，管理工具集合
- **browser_use_tool.py**: 实现网页浏览工具
- **google_search.py**: 实现谷歌搜索工具
- **python_execute.py**: 实现Python代码执行工具
- **file_saver.py**: 实现文件保存工具
- **terminate.py**: 实现终止代理执行的工具

#### 5.1.3 app/schema

- 定义系统中使用的数据模型
- 包括Message、Memory、AgentState等

#### 5.1.4 app/llm.py

- 封装与大语言模型的交互
- 支持不同的LLM提供商和模型
- 实现重试机制和错误处理

#### 5.1.5 app/config.py

- 加载和管理配置
- 支持不同环境的配置

#### 5.1.6 app/logger.py

- 提供日志功能
- 支持不同级别的日志记录

#### 5.1.7 app/prompt

- 存储系统使用的提示模板
- 包括系统提示和下一步提示

### 5.2 config包

- 存储配置文件
- 包括LLM配置、工具配置等

### 5.3 templates和static包

- 存储Web应用的前端资源
- 包括HTML模板、CSS、JavaScript等

## 6. 执行流程

1. 用户通过命令行或Web界面提交请求
2. 系统创建Manus代理实例
3. 代理进入ReAct循环:
   - **思考(Think)**: 分析当前状态，决定下一步行动
   - **行动(Act)**: 执行工具调用或生成响应
4. 代理使用工具与外部系统交互（浏览网页、执行代码、搜索信息等）
5. 结果返回给用户，并可通过Web界面实时显示执行过程

## 7. 部署方式

项目支持两种主要的运行方式：

1. **命令行模式**: 通过`main.py`运行，适合简单交互
2. **Web应用模式**: 通过`app.py`运行，提供Web界面和API

## 8. 扩展性

OpenManus设计具有高度扩展性：

1. **工具扩展**: 可以通过实现BaseTool接口添加新工具
2. **代理扩展**: 可以扩展现有代理类或创建新的代理类型
3. **LLM扩展**: 支持配置不同的LLM提供商和模型

## 9. 安全考虑

项目实现了多种安全机制：

1. **Python执行沙箱**: 限制Python代码执行的权限和超时
2. **API密钥管理**: 通过配置文件管理敏感凭据
3. **错误处理**: 全面的异常捕获和处理机制

## 10. 未来发展方向

1. 增加更多工具和能力
2. 改进代理的推理能力
3. 支持更多LLM提供商
4. 增强Web界面的用户体验
5. 实现更好的多代理协作

## 11. 总结

OpenManus是一个功能全面的AI代理框架，采用了现代化的架构设计和技术栈。它提供了丰富的工具集和灵活的扩展机制，使用户能够构建强大的AI代理来解决各种任务。项目的模块化设计使其易于理解、扩展和维护，适合用于研究、教育和实际应用场景。 